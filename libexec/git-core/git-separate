#!/usr/bin/ruby -w
# vim:syntax=ruby

if File.exist?("all.txt") then  
    object_file = File

    clean_objects = if ARGV.include?('--clean') then
        true 
    else
        false
    end

    File.open("all.txt").each_line do |line|

        file_name = case 
            when line.match('^OBJECT Table.*')
                "TAB" + line.split[2] + ".TXT"
            when line.match('^OBJECT Form.*')
                "FOR" + line.split[2] + ".TXT"
            when line.match('^OBJECT Report.*')
                "REP" + line.split[2] + ".TXT"
            when line.match('^OBJECT Dataport.*')
                "DAT" + line.split[2] + ".TXT"
            when line.match('^OBJECT XMLPort.*')
                "XML" + line.split[2] + ".TXT"
            when line.match('^OBJECT Codeunit.*')
                "COD" + line.split[2] + ".TXT"
            when line.match("^OBJECT MenuSuite.*")
                "MEN" + line.split[2] + ".TXT"
            when line.match('^OBJECT Page.*')
                "PAG" + line.split[2] + ".TXT"
            when line.match('^OBJECT Query.*')
                "QUE" + line.split[2] + ".TXT"
        end
        
        unless file_name.nil? 
            # New NAV object was found in the combined file
            File.exist?(file_name) { File.delete(file_name) }
            object_file = File.open(file_name,"w")
        end
        
        if !clean_objects || !line.match('.*Modified=Yes;') then
            object_file.write(line)
        end
    end 
end
